rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function userExistsInFirestore() {
      return firestore.exists(/databases/(default)/documents/users/$(request.auth.uid));
    }
    
    function isTeamMember(teamId) {
      return userExistsInFirestore() && 
             firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.teamId == teamId;
    }
    
    // Profil resimleri
    match /profilePics/{userId}/{fileName} {
      allow read: if request.auth != null;
      // Yazma: Authenticated ve kendi profil resmi olmalı
      // NOT: Firestore'da user henüz yoksa da izin ver (yeni kayıt için)
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size < 5 * 1024 * 1024 &&
                      request.resource.contentType.matches('image/.*');
    }
    
    //  Chat media dosyaları
    match /chat_media/{mediaType}/{fileName} {
      // Okuma: Authenticated kullanıcılar
      allow read: if request.auth != null;
      
      // Yazma: File boyutu ve tip kontrolü
      allow write: if request.auth != null && 
                      request.resource.size < 25 * 1024 * 1024 && // 25MB limit
                      (
                        // Image types
                        (mediaType == 'image' && request.resource.contentType.matches('image/.*')) ||
                        // Video types
                        (mediaType == 'video' && request.resource.contentType.matches('video/.*')) ||
                        // Audio types
                        (mediaType == 'audio' && request.resource.contentType.matches('audio/.*')) ||
                        // Document types
                        (mediaType == 'document' && 
                         (request.resource.contentType.matches('application/pdf') ||
                          request.resource.contentType.matches('application/.*document.*') ||
                          request.resource.contentType.matches('text/.*')))
                      );
    }
    
    // Takım dosyaları (eğer kullanılıyorsa)
    match /teams/{teamId}/{allPaths=**} {
      allow read: if request.auth != null && isTeamMember(teamId);
      allow write: if request.auth != null && 
                      isTeamMember(teamId) &&
                      request.resource.size < 10 * 1024 * 1024;
    }
  }
}