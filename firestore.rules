rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function isAdmin() {
      return userExists() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamRole == 'admin';
    }
    
    function isMemberOfTeam(teamId) {
      return userExists() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
    }

    // Referral kodları
    match /referral_codes/{code} {
      // Okuma: Herkes (kod doğrulama için gerekli)
      allow read: if true;
      
      // Oluşturma: Authenticated kullanıcılar (yeni takım oluşturma için)
      allow create: if request.auth != null &&
                       request.resource.data.keys().hasAll(['code', 'teamId', 'createdBy', 'createdAt', 'isActive', 'expiresAt']) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.isActive == true;
      
      // Güncelleme: Kod kullanımı için (usedBy, usedAt, isActive alanları)
      allow update: if request.auth != null && (
        // Kod sahibi her şeyi değiştirebilir
        resource.data.createdBy == request.auth.uid ||
        // Veya kod kullanılıyorsa sadece bu alanlar değişebilir
        (resource.data.isActive == true && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedBy', 'usedAt', 'isActive']) &&
         request.resource.data.usedBy == request.auth.uid &&
         request.resource.data.isActive == false)
      );
      
      // Silme: Sadece kod sahibi
      allow delete: if request.auth != null && 
                       resource.data.createdBy == request.auth.uid;
    }

    // Kullanıcılar
    match /users/{userId} {
      allow read: if request.auth != null;
      
      // Kullanıcı oluşturma: Sadece kendi ID'si için ve gerekli alanlar var
      allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.keys().hasAll(['id', 'name', 'email', 'createdAt', 'hasTeam']) &&
                       request.resource.data.id == userId &&
                       request.resource.data.email == request.auth.token.email;
      
      // Kullanıcı güncelleme: Kendi profili veya admin
      allow update: if request.auth != null && (
        (request.auth.uid == userId && 
         // Kritik alanları değiştiremesin (email, id, createdAt)
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['id', 'email', 'createdAt'])) ||
        isAdmin()
      );
      
      // Silme: Sadece admin veya kendisi (ama nadiren gerekir)
      allow delete: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Kullanıcı alt chat koleksiyonu
      match /chats/{chatId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Takımlar
    match /teams/{teamId} {
      // Okuma: Authenticated kullanıcılar (takım listesi için gerekli)
      allow read: if request.auth != null;
      
      // Oluşturma: Sadece kendi takımını oluşturabilir ve gerekli alanlar olmalı
      allow create: if request.auth != null && 
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.keys().hasAll(['name', 'createdAt', 'createdBy', 'memberCount', 'isActive']) &&
                       request.resource.data.memberCount == 1 &&
                       request.resource.data.isActive == true;
      
      // Güncelleme: Admin veya takım üyesi (belirli alanlar için)
      allow update: if request.auth != null && (
        // Admin her şeyi değiştirebilir
        isAdmin() ||
        // Takım üyeleri sadece belirli alanları değiştirebilir (memberCount, referralCode gibi sistem alanları hariç)
        (isMemberOfTeam(teamId) && 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['createdBy', 'createdAt']))
      );
      
      // Silme: Sadece admin veya takım sahibi
      allow delete: if request.auth != null && (
        isAdmin() || 
        resource.data.createdBy == request.auth.uid
      );
      
      //  Görevler (subcollection)
      match /tasks/{taskId} {
        // Okuma: Takım üyesi
        allow read: if request.auth != null && isMemberOfTeam(teamId);
        
        // Oluşturma: Takım üyesi ve uploadedBy doğru olmalı
        allow create: if request.auth != null && 
                         isMemberOfTeam(teamId) &&
                         request.resource.data.uploadedBy == request.auth.uid &&
                         request.resource.data.teamId == teamId;
        
        // Güncelleme: Takım üyesi
        allow update: if request.auth != null && isMemberOfTeam(teamId);
        
        // Silme: Admin veya görev sahibi
        allow delete: if request.auth != null && (
          isAdmin() || 
          resource.data.uploadedBy == request.auth.uid
        );
      }
    }

    // Takım üyeleri
    match /team_members/{memberId} {
      // Okuma: Authenticated kullanıcılar
      allow read: if request.auth != null;
      
      // Oluşturma: Kullanıcı kendi üyeliğini oluşturabilir veya admin
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin()
      ) &&
      request.resource.data.keys().hasAll(['userId', 'teamId', 'role', 'isActive']);
      
      // Güncelleme: Sadece admin veya sistem (role değişikliği için)
      allow update: if request.auth != null && (
        isAdmin() ||
        // Kullanıcı sadece kendi isActive durumunu değiştirebilir
        (resource.data.userId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isActive']))
      );
      
      // Silme: Admin veya kendisi (takımdan ayrılma)
      allow delete: if request.auth != null && (
        isAdmin() || 
        resource.data.userId == request.auth.uid
      );
    }

    //  Groups collection
    match /groups/{groupId} {
      // Okuma: Authenticated kullanıcılar
      allow read: if request.auth != null;
      
      // Oluşturma: Herkes grup oluşturabilir ve kendisi memberIds'de olmalı
      allow create: if request.auth != null &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.auth.uid in request.resource.data.memberIds &&
                       request.resource.data.keys().hasAll(['name', 'createdBy', 'createdAt', 'memberIds']);
      
      // Güncelleme: Grup sahibi veya üyeler
      allow update: if request.auth != null && (
        resource.data.createdBy == request.auth.uid || 
        request.auth.uid in resource.data.memberIds
      );
      
      // Silme: Sadece grup sahibi
      allow delete: if request.auth != null && 
                       resource.data.createdBy == request.auth.uid;
      
      // Group messages
      match /messages/{messageId} {
        // Okuma: Grup üyesi
        allow read: if request.auth != null && 
                      request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.memberIds;
        
        // Oluşturma: Grup üyesi ve senderId doğru olmalı
        allow create: if request.auth != null && 
                         request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.memberIds &&
                         request.resource.data.senderId == request.auth.uid;
        
        // Güncelleme/Silme: Sadece mesaj sahibi
        allow update, delete: if request.auth != null && 
                                 resource.data.senderId == request.auth.uid;
      }
    }

    //  Chats collection (1-on-1 mesajlar)
    match /chats/{chatId} {
      // Okuma: Authenticated kullanıcılar (chatId'de kendi ID'si olmalı idealinde)
      allow read: if request.auth != null;
      
      // Oluşturma: Chat başlatabilir
      allow create: if request.auth != null &&
                       request.resource.data.keys().hasAll(['participants', 'createdAt', 'lastMessage']) &&
                       request.auth.uid in request.resource.data.participants;
      
      // Güncelleme: Chat katılımcıları
      allow update: if request.auth != null &&
                       request.auth.uid in resource.data.participants;
      
      // Silme: Chat katılımcıları
      allow delete: if request.auth != null &&
                       request.auth.uid in resource.data.participants;
      
      // Chat messages subcollection
      match /messages/{messageId} {
        // Okuma: Authenticated (chat katılımcısı kontrolü parent'ta)
        allow read: if request.auth != null;
        
        // Oluşturma: Mesaj sahibi doğru olmalı
        allow create: if request.auth != null && 
                         request.resource.data.senderId == request.auth.uid &&
                         request.resource.data.keys().hasAll(['senderId', 'content', 'timestamp']);
        
        // Güncelleme/Silme: Sadece mesaj sahibi
        allow update, delete: if request.auth != null && 
                                 resource.data.senderId == request.auth.uid;
      }
    }

    //  Notifications collection
    match /notifications/{notificationId} {
      // Sadece kendi bildirimlerini okuyabilir (uploadedBy field'ı kullanılıyor)
      allow read: if request.auth != null && 
                     resource.data.uploadedBy == request.auth.uid;
      // Herkes bildirim oluşturabilir (sistem/cloud functions için)
      allow create: if request.auth != null;
      // Sadece kendi bildirimini silebilir
      allow delete: if request.auth != null && 
                       resource.data.uploadedBy == request.auth.uid;
      // Update sadece read status için (okundu işaretleme)
      allow update: if request.auth != null && 
                       resource.data.uploadedBy == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
    }
  }
}